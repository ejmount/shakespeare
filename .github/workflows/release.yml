name: Mint Release

on:
    workflow_dispatch:
        inputs:
            dry-run:
                description: "Dry-run cargo publish and mark the GH release as prerelease"
                required: false
                type: boolean


jobs:
    publish:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        steps:
            - name: Checkout sources
              uses: actions/checkout@v2
              with:
                submodules: true
            - name: Check semver
              uses: obi1kenobi/cargo-semver-checks-action@v2
              with:
                exclude: xtask

            - name: Get release tag
              id: release-tag
              # Using shell: bash explicitly because it turns on safety features like pipefail
              shell: bash
              run: |
                echo "tag=v$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "shakespeare").version')" >> "$GITHUB_OUTPUT"

            - name: Release
              uses: softprops/action-gh-release@v2
              with:
                name: ${{ steps.release-tag.outputs.tag }}
                draft: ${{ inputs.dry-run }}
                prerelease: ${{ inputs.dry-run }}

            - name: Publish to Crates.io
              uses: katyo/publish-crates@v2
              with:
                dry-run: ${{ inputs.dry-run }}
                registry-token: ${{ secrets.CRATESIO_TOKEN }}
